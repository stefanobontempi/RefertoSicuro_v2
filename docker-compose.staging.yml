# ============================================
# Docker Compose - STAGING Environment
# ============================================
# Hetzner VPS: refertosicuro-staging01
# IP: 91.99.223.25
# Ottimizzato per 2GB RAM
# ============================================

version: "3.8"

networks:
  refertosicuro-network:
    driver: bridge

volumes:
  postgres_data_staging:
  mongo_data_staging:
  redis_data_staging:
  rabbitmq_data_staging:
  vault_data_staging:

services:
  # ===========================================
  # INFRASTRUCTURE
  # ===========================================

  postgres:
    image: postgres:15-alpine
    container_name: refertosicuro-postgres-staging
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-refertosicuro_staging}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Database password required}
      POSTGRES_DB: ${POSTGRES_DB:-refertosicuro_staging}
    volumes:
      - postgres_data_staging:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - refertosicuro-network
    restart: unless-stopped
    healthcheck:
      test:
        ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-refertosicuro_staging}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M

  mongodb:
    image: mongo:7
    container_name: refertosicuro-mongodb-staging
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USER:-refertosicuro_staging}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:?MongoDB password required}
      MONGO_INITDB_DATABASE: ${MONGODB_DATABASE:-refertosicuro_staging}
    volumes:
      - mongo_data_staging:/data/db
    ports:
      - "27017:27017"
    networks:
      - refertosicuro-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M

  redis:
    image: redis:7-alpine
    container_name: refertosicuro-redis-staging
    command: redis-server --requirepass ${REDIS_PASSWORD:?Redis password required}
    volumes:
      - redis_data_staging:/data
    ports:
      - "6379:6379"
    networks:
      - refertosicuro-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 128M

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: refertosicuro-rabbitmq-staging
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-refertosicuro_staging}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:?RabbitMQ password required}
    volumes:
      - rabbitmq_data_staging:/var/lib/rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672" # Management UI
    networks:
      - refertosicuro-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M

  vault:
    image: hashicorp/vault:1.15
    container_name: refertosicuro-vault-staging
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_TOKEN:?Vault token required}
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    volumes:
      - vault_data_staging:/vault/data
    ports:
      - "8200:8200"
    networks:
      - refertosicuro-network
    restart: unless-stopped
    command: server -dev
    deploy:
      resources:
        limits:
          memory: 128M

  # ===========================================
  # MICROSERVICES (lightweight staging)
  # ===========================================

  auth-service:
    build:
      context: ./services/auth
      dockerfile: Dockerfile
    container_name: refertosicuro-auth-staging
    environment:
      - ENVIRONMENT=staging
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/auth_staging
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=${VAULT_TOKEN}
    ports:
      - "8010:8010"
    networks:
      - refertosicuro-network
    depends_on:
      - postgres
      - redis
      - vault
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M

  billing-service:
    build:
      context: ./services/billing
      dockerfile: Dockerfile
    container_name: refertosicuro-billing-staging
    environment:
      - ENVIRONMENT=staging
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/billing_staging
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/1
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/
    ports:
      - "8012:8012"
    networks:
      - refertosicuro-network
    depends_on:
      - postgres
      - redis
      - rabbitmq
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M

  admin-service:
    build:
      context: ./services/admin
      dockerfile: Dockerfile
    container_name: refertosicuro-admin-staging
    environment:
      - ENVIRONMENT=staging
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/admin_staging
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/2
    ports:
      - "8013:8013"
    networks:
      - refertosicuro-network
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M

  analytics-service:
    build:
      context: ./services/analytics
      dockerfile: Dockerfile
    container_name: refertosicuro-analytics-staging
    environment:
      - ENVIRONMENT=staging
      - MONGODB_URL=mongodb://${MONGODB_USER}:${MONGODB_PASSWORD}@mongodb:27017/analytics_staging
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/
    ports:
      - "8014:8014"
    networks:
      - refertosicuro-network
    depends_on:
      - mongodb
      - rabbitmq
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M

  notification-service:
    build:
      context: ./services/notification
      dockerfile: Dockerfile
    container_name: refertosicuro-notification-staging
    environment:
      - ENVIRONMENT=staging
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/notification_staging
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@rabbitmq:5672/
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    ports:
      - "8015:8015"
    networks:
      - refertosicuro-network
    depends_on:
      - postgres
      - rabbitmq
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M

  # ===========================================
  # FRONTEND
  # ===========================================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=http://91.99.223.25:8010
        - VITE_ENVIRONMENT=staging
    container_name: refertosicuro-frontend-staging
    ports:
      - "3000:80"
    networks:
      - refertosicuro-network
    depends_on:
      - auth-service
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M

  # ===========================================
  # MONITORING (lightweight)
  # ===========================================

  grafana:
    image: grafana/grafana:10.2.0
    container_name: refertosicuro-grafana-staging
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=
    ports:
      - "3001:3000"
    networks:
      - refertosicuro-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
